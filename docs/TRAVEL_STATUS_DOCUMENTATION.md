# توثيق حالات السفر (Travel Status)

## نظرة عامة

حالة السفر (`TravelStatusEnum`) تصف المرحلة الحالية لأي رحلة في النظام. الحالات تتغير تلقائياً أو يدوياً حسب حدث أو فعل معين.

---

## قائمة الحالات

| الحالة | الاسم بالإنجليزي | الوصف |
|--------|------------------|-------|
| معلقة | `PENDING` | الرحلة حديثة، لا يوجد حجوزات بعد |
| حجز | `BOOKING` | يوجد حجوزات ولكن لم يكتمل العدد |
| مكتملة الحجز | `FULLY_BOOKED` | تم حجز كل المقاعد المتاحة |
| بدأت | `STARTED` | الرحلة بدأت فعلياً |
| قيد التنفيذ | `IN_PROGRESS` | الرحلة جارية |
| حادث | `ACCIDENT` | حدث حادث أثناء الرحلة |
| عطل | `MALFUNCTION` | حدث عطل في المركبة أثناء الرحلة |
| انتهت | `FINISHED` | الرحلة انتهت بنجاح |
| ملغية | `CANCELLED` | تم إلغاء الرحلة |

---

## الحالات التي تُعيّن تلقائياً (النظام)

### 1. PENDING (معلقة)

**متى تُعيّن:**
- عند إنشاء الرحلة لأول مرة (القيمة الافتراضية)

**من يُنشئها:** السائق (عند إنشاء الرحلة عبر `create`)

**ماذا تسمح:**
- تعديل بيانات الرحلة (المكان، الوقت، السعر، عدد المقاعد...)
- الحجز من الركاب (إنشاء `travel_passenger`)
- تحديث بيانات الرحلة خلال 30 دقيقة من الإنشاء فقط

**ماذا تمنع:**
- لا تمنع شيء في هذه المرحلة

---

### 2. BOOKING (حجز)

**متى تُعيّن:**
- عندما يحجز أول راكب رحلة كانت `PENDING`

**من يُنشئها:** النظام (تلقائياً عند أول حجز في `travels_passengers.service.create`)

**ماذا تسمح:**
- الحجز من الركاب
- الدفع من الركاب الذين قبل السائق طلباتهم

**ماذا تمنع:**
- تعديل بيانات الرحلة (يُرفض لأن الحالة لم تعد `PENDING`)

---

### 3. FULLY_BOOKED (مكتملة الحجز)

**متى تُعيّن:**
- عندما يدفع راكب ويكون عدد الركاب المدفوعين مساوياً لعدد المقاعد المتاحة

**من يُنشئها:** النظام (تلقائياً في `payToConfirm` داخل `travels_passengers.service`)

**ماذا تسمح:**
- لا يسمح بحجوزات جديدة عملياً (المقاعد ممتلئة)

**ماذا تمنع:**
- لا يمكن اختيار هذه الحالة يدوياً في تحديث الحالة (السائق لا يختارها)

---

## الحالات التي يختارها السائق يدوياً

السائق يحدّث حالة الرحلة عبر `PATCH /travels/:id/status` فقط. الحالات المسموح اختيارها يدوياً:

- `STARTED`
- `IN_PROGRESS`
- `ACCIDENT`
- `MALFUNCTION`
- `FINISHED`
- `CANCELLED`

الحالات الممنوعة يدوياً: `PENDING`, `BOOKING`, `FULLY_BOOKED`.

---

### 4. STARTED (بدأت)

**متى تُعيّن:** عند وصول وقت بدء الرحلة أو بدء الرحلة فعلياً

**من يُنشئها:** السائق فقط (يدوياً عبر `updateStatus`)

**قيد مهم:** يجب أن يكون جميع الركاب قد حدّثوا حالتهم إلى `STARTED` أولاً، وإلا يُرفض التحديث برسالة:  
`"Can't update status if passenger didn't updated"`

---

### 5. IN_PROGRESS (قيد التنفيذ)

**متى تُعيّن:** أثناء تنفيذ الرحلة

**من يُنشئها:** السائق فقط (يدوياً)

**قيد:** نفس قيد `STARTED` — يجب تحديث حالات الركاب أولاً.

---

### 6. ACCIDENT (حادث)

**متى تُعيّن:** عند وقوع حادث أثناء الرحلة

**من يُنشئها:** السائق فقط (يدوياً)

**قيد:** نفس قيد `STARTED` — يجب تحديث حالات الركاب أولاً.

---

### 7. MALFUNCTION (عطل)

**متى تُعيّن:** عند حدوث عطل في المركبة أثناء الرحلة

**من يُنشئها:** السائق فقط (يدوياً)

**قيد:** نفس قيد `STARTED` — يجب تحديث حالات الركاب أولاً.

---

### 8. FINISHED (انتهت)

**متى تُعيّن:** عند انتهاء الرحلة بنجاح

**من يُنشئها:** السائق فقط (يدوياً)

**قيد:** نفس قيد `STARTED` — يجب تحديث حالات الركاب أولاً.

---

### 9. CANCELLED (ملغية)

**متى تُعيّن:** عند إلغاء الرحلة

**من يُنشئها:** السائق فقط (يدوياً)

**استثناء:** هذه الحالة الوحيدة التي لا تحتاج إلى تحديث حالات الركاب أولاً. السائق يمكنه إلغاء الرحلة مباشرة دون انتظار تحديث الركاب.

---

## مخطط تدفق الحالات (مبسط)

```
[إنشاء الرحلة]
       ↓
   PENDING ←── يمكن تعديل الرحلة خلال 30 دقيقة
       ↓
[أول حجز]
       ↓
   BOOKING ←── يمكن الحجز والدفع
       ↓
[عدد المدفوعين = المقاعد]
       ↓
FULLY_BOOKED
       ↓
[السائق يحدّث الحالة]
       ↓
STARTED → IN_PROGRESS → FINISHED
    │            │
    │            ├── ACCIDENT
    │            └── MALFUNCTION
    │
    └── CANCELLED (في أي وقت من السائق)
```

---

## ملخص من يفعل ماذا

| الدور | الإجراء | الحالة الناتجة |
|-------|---------|-----------------|
| السائق | إنشاء رحلة | `PENDING` |
| السائق | تعديل الرحلة | يبقى `PENDING` (مع قيد 30 دقيقة) |
| النظام | أول حجز | `PENDING` → `BOOKING` |
| النظام | اكتمال الحجوزات بالدفع | `BOOKING` → `FULLY_BOOKED` |
| السائق | تحديث حالة الرحلة | `STARTED`, `IN_PROGRESS`, `ACCIDENT`, `MALFUNCTION`, `FINISHED`, `CANCELLED` |

---

## ملاحظات فنية

1. **تحديث الحالة من السائق:**  
   API: `PATCH /travels/:id/status` — يجب أن يكون المستخدم هو السائق الخاص بالسيارة المرتبطة بالرحلة.

2. **شرط تحديث الحالة (ما عدا CANCELLED):**  
   يجب أن يكون هناك على الأقل راكب واحد لم يُحدَّث حالته للحالة الجديدة. إذا كان كل الركاب محدّثين، يظهر خطأ لأن التحديث غير ضروري.

3. **ربط الحالة مع حالة الراكب:**  
   حالات الرحلة مثل `STARTED`, `IN_PROGRESS`, `FINISHED`, `ACCIDENT`, `MALFUNCTION` يجب أن تكون متناسقة مع حالات الركاب (`TravelPassengerStatusEnum`) قبل أن يحدّث السائق حالة الرحلة.
